default_task: &default_task
  account: '&ACCOUNT;'
  attrs:
    cycledefs: forecast
    maxtries: '1'
  envars: &default_vars
    GLOBAL_VAR_DEFNS_FP: '&GLOBAL_VAR_DEFNS_FP;'
    USHdir: '{{ user.USHdir }}'
    PDY: !cycstr "@Y@m@d"
    cyc: !cycstr "@H"
    nprocs: '{{ parent.nnodes * parent.ppn }}'
    subcyc: !cycstr "@M"
    LOGDIR: !cycstr "&LOGDIR;"
    ENSMEM_INDX: '#mem#'
  native: '{{ platform.SCHED_NATIVE_CMD }}'
  nodes: '{{ nnodes }}:ppn={{ ppn }}'
  nodesize: "&NCORES_PER_NODE;"
  queue: '&QUEUE_DEFAULT;'
  walltime: 00:30:00

task_get_extrn_ics:
  <<: *default_task
  command: '&LOAD_MODULES_RUN_TASK_FP; "get_extrn_ics" "&JOBSDIR;/JREGIONAL_GET_EXTRN_MDL_FILES"'
  envars:
    <<: *default_vars
    ICS_OR_LBCS: ICS
  join: !cycstr '&LOGDIR;/{{ jobname }}.log'
  memory: 2G
  nnodes: 1
  ppn: 1
  queue: '&QUEUE_HPSS;'
  walltime: 00:45:00

task_get_extrn_lbcs:
  <<: *default_task
  command: '&LOAD_MODULES_RUN_TASK_FP; "get_extrn_lbcs" "&JOBSDIR;/JREGIONAL_GET_EXTRN_MDL_FILES"'
  envars:
    <<: *default_vars
    ICS_OR_LBCS: LBCS
  join: !cycstr '&LOGDIR;/{{ jobname }}.log'
  memory: 2G
  nnodes: 1
  ppn: 1
  queue: '&QUEUE_HPSS;'
  walltime: 00:45:00

metatask_run_ensemble:
  var:
    mem: '{% if global.DO_ENSEMBLE  %} "{%- for m in range(1, NUM_ENS_MEMBERS+1) -%}{{ "%03d"%m }}{%- endfor -%} {% else %}{{ "det" }}{% endif %}'
  task_make_ics_#mem#:
    <<: *default_task
    command: '&LOAD_MODULES_RUN_TASK_FP; "make_ics" "&JOBSDIR;/JREGIONAL_MAKE_ICS"'
    envars:
      <<: *default_vars
      SLASH_ENSMEM_SUBDIR: '{% if global.DO_ENSEMBLE  %}{{ "/mem#mem#" }}{% else %}{{ "/" }}{% endif %}'
    join: !cycstr '&LOGDIR;/{{ jobname }}.log'

    nnodes: 4
    ppn: 12
    dependency:
      and: &make_ics_deps
        taskdep_get_extrn:
          attrs:
            task: get_extrn_ics
        or_grid:
          datadep_grid:
            attrs:
              age: 00:00:00:05
            text: '{{ task_make_grid.GRID_DIR }}/make_grid_task_complete.txt'
          streq:
            left: staged_grid
            right: '{% if not rocoto.get("tasks", {}).get("task_make_grid") %}staged_grid{% endif %}'
        or_orog:
          datadep_orog:
            attrs:
              age: 00:00:00:05
            text: '{{ task_make_orog.OROG_DIR }}/make_orog_task_complete.txt'
          streq:
            left: staged_orog
            right: '{% if not rocoto.get("tasks", {}).get("task_make_orog") %}staged_orog{% endif %}'
        or_sfc_climo:
          datadep_sfc_climo:
            attrs:
              age: 00:00:00:05
            text: '{{ task_make_sfc_climo.SFC_CLIMO_DIR }}/make_sfc_climo_task_complete.txt'
          streq:
            left: staged_sfc_climo
            right: '{% if not rocoto.get("tasks", {}).get("task_make_sfc_climo") %}staged_sfc_climo{% endif %}'

  task_make_lbcs_#mem#:
    <<: *default_task
    command: '&LOAD_MODULES_RUN_TASK_FP; "make_lbcs" "&JOBSDIR;/JREGIONAL_MAKE_LBCS"'
    envars:
      <<: *default_vars
      SLASH_ENSMEM_SUBDIR: '{% if global.DO_ENSEMBLE  %}{{ "/mem#mem#" }}{% else %}{{ "/" }}{% endif %}'
    join: !cycstr '&LOGDIR;/{{ jobname }}.log'
    nnodes: 4
    ppn: 12
    dependency:
      and:
        <<: *make_ics_deps
        taskdep_get_extrn:
          attrs:
            task: get_extrn_lbcs

  task_run_fcst_#mem#:
    <<: *default_task
    command: '&LOAD_MODULES_RUN_TASK_FP; "run_fcst" "&JOBSDIR;/JREGIONAL_RUN_FCST"'
    envars:
      <<: *default_vars
      SLASH_ENSMEM_SUBDIR: '{% if global.DO_ENSEMBLE  %}{{ "/mem#mem#" }}{% else %}{{ "/" }}{% endif %}'
      nprocs:
    join: !cycstr '&LOGDIR;/{{ jobname }}.log'
    nodesize: '{{ platform.NCORES_PER_NODE }}'
    nnodes: '{{ task_run_fcst.NNODES_RUN_FCST|int }}'
    ppn: '{{ task_run_fcst.PPN_RUN_FCST|int }}'
    queue: '&QUEUE_FCST;'
    walltime: 04:30:00
    dependency:
      and:
        taskdep_make_ics:
          attrs:
            task: make_ics
        taskdep_make_lbcs:
          attrs:
            task: make_lbcs

