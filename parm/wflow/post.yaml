default_task_post: &default_task
  account: '&ACCOUNT;'
  attrs:
    cycledef: forecast
    maxtries: '2'
  command: '&LOAD_MODULES_RUN_TASK_FP; "run_post" "&JOBSDIR;/JREGIONAL_RUN_POST"'
  envars: &default_vars
    GLOBAL_VAR_DEFNS_FP: '&GLOBAL_VAR_DEFNS_FP;'
    USHdir: '{{ user.USHdir }}'
    PDY: !cycstr '@Y@m@d'
    CDATE: !cycstr '@Y@m@d@H'
    CYCLE_DIR: !cycstr '&CYCLE_BASEDIR;/@Y@m@d@H'
    SLASH_ENSMEM_SUBDIR: '{% if global.DO_ENSEMBLE  %}{{ "/mem#mem#" }}{% else %}{{ "/" }}{% endif %}'
    ENSMEM_INDX: '#mem#'
    cyc: !cycstr '@H'
    fhr: '#fhr#'
    nprocs: '{{ nnodes * ppn }}'
  join: !cycstr '&LOGDIR;/{{ jobname }}_@Y@m@d@H.log'
  native: '{{ platform.SCHED_NATIVE_CMD }}'
  nodes: '{{ nnodes }}:ppn={{ ppn }}'
  nnodes: 2
  ppn: 24
  nodesize: "&NCORES_PER_NODE;"
  queue: '&QUEUE_DEFAULT;'
  walltime: 00:15:00

metatask_run_ens_post:
  var:
    mem: '{% if global.DO_ENSEMBLE  %} "{%- for m in range(1, NUM_ENS_MEMBERS+1) -%}{{ "%03d"%m }}{%- endfor -%} {% else %}{{ "det" }}{% endif %}'
  metatask_run_post:
    var:
      fhr: '{% for h in range(1, FCST_LEN_HRS+1) %}{{ " %03d" % h }}{% endfor %}'
    task_run_post_f#fhr#:
      <<: *default_task
      dependency:
        or:
          taskdep:
            attrs:
              task: run_fcst
          and:
            datadep_dyn:
              text: !cycstr '&CYCLE_BASEDIR;/@Y@m@d@H/dynf#fhr#.nc'
              attrs:
                age: '05:00'
            datadep_phy:
              text: !cycstr '&CYCLE_BASEDIR;/@Y@m@d@H/phyf#fhr#.nc'
              attrs:
                age: '05:00'

  metatask_run_sub_hourly_post:
    var:
      fhr: '{% for h in range(FCST_LEN_HRS) %}{{ " %03d" % h }}{% endfor %}'
    metatask_sub_hourly_post:
      var:
        fmn: '{% for min in range(0, 60, DT_SUBHOURLY_POST_MNTS) %}{{ " %02d" % min }}{% endfor %}'
      task_run_post_f#fhr##fmn#: &subhourly_run_post_task
        <<: *default_task
        envars:
          <<: *default_vars
          fmn: '#fmn#'
        dependency:
          or:
            taskdep:
              attrs:
                task: run_fcst
            and:
              datadep_dyn:
                text: !cycstr '&CYCLE_BASEDIR;/@Y@m@d@H/dynf#fhr#:#fmn#:00.nc'
                attrs:
                  age: '05:00'
              datadep_phy:
                text: !cycstr '&CYCLE_BASEDIR;/@Y@m@d@H/phyf#fhr#:#fmn#:00.nc'
                attrs:
                  age: '05:00'

  metatask_sub_hourly_last_hour_post:
    var:
      fhr: '{{ " %03d" % FCST_LEN_HRS }}'
      fmn: '00'
    task_run_post:
      <<: &subhourly_run_post_task
