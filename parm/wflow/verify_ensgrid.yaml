default_task_verify_ens: &default_task
  account: '&ACCOUNT;'
  envars: &default_vars
    GLOBAL_VAR_DEFNS_FP: '&GLOBAL_VAR_DEFNS_FP;'
    USHdir: '{{ user.USHdir }}'
    PDY: !cycstr '@Y@m@d'
    cyc: !cycstr "@H"
    subcyc: !cycstr "@M"
    LOGDIR: !cycstr "&LOGDIR;"
    FHR: '{% for h in range(0, expt.fcst_len_hrs+1) %}{{ " %02d" % h  }}{% endfor %}'
    SLASH_ENSMEM_SUBDIR: '&SLASH_ENSMEM_SUBDIR;'
    nprocs: '{{ nnodes * ppn }}'
  join: !cycstr '&LOGDIR;/{{ jobname }}_@Y@m@d@H.log'
  memory: '{% if user.MACHINE not in ["WCOSS2", "NOAACLOUD"] %}{{ "2G" }}{% endif %}'
  native: '{{ platform.SCHED_NATIVE_CMD }}'
  nnodes: 1
  nodes: '{{ nnodes }}:ppn={{ ppn }}'
  nodesize: '&NCORES_PER_NODE;'
  partition: '{% if platform.get("PARTITION_DEFAULT") %}&PARTITION_DEFAULT;{% else %}None{% endif %}'
  ppn: 1
  queue: '&QUEUE_DEFAULT;'
  walltime: 01:00:00

metatask_ensgridvx:
  var:
    VAR: APCP REFC RETOP
    OBS_DIR: '&CCPA_OBS_DIR; &MRMS_OBS_DIR; &MRMS_OBS_DIR;'
  task_run_ensgridvx_#VAR#:
    command: '&LOAD_MODULES_RUN_TASK_FP; "run_vx" "&JOBSDIR;/JREGIONAL_RUN_VX_ENSGRID"'
    envars:
      <<: *default_vars
      ACCUM: 01
      OBS_DIR: '#OBS_DIR#'
      VAR: '#VAR#'
    dependency:
      metataskdep:
        attrs:
          metatask: run_ensemble

metatask_ensgridvx_prob:
  var:
    VAR: APCP REFC RETOP
    OBS_DIR: '&CCPA_OBS_DIR; &MRMS_OBS_DIR; &MRMS_OBS_DIR;'
  task_run_ensgridvx_prob_#VAR#:
    command: '&LOAD_MODULES_RUN_TASK_FP; "run_vx" "&JOBSDIR;/JREGIONAL_RUN_VX_ENSGRID_PROB"'
    envars:
      <<: *default_vars
      ACCUM: 01
      OBS_DIR: '#OBS_DIR#'
      VAR: '#VAR#'
    dependency:
      metataskdep:
        attrs:
          metatask: run_ensgridvx_#VAR#

metatask_ensgridvx_acc:
  var:
    ACCUM_HR: 03 06 24
    FCST_HR_LIST: '&3HRLY_FH; &6HRLY_FH; &24HRLY_FH;'
  task_run_ensgridvx_#ACCUM_HR#h:
    <<: *default_task
    command: '&LOAD_MODULES_RUN_TASK_FP; "run_vx" "&JOBSDIR;/JREGIONAL_RUN_VX_ENSGRID"'
    envars:
      <<: *default_vars
      ACCUM: '#ACCUM_HR#'
      FHR: '#FCST_HR_LIST#'
      OBS_DIR: '&CCPA_OBS_DIR;'
      VAR: APCP
    dependency:
      taskdep:
        attrs:
          task: run_ensgridvx_APCP

metatask_ensgridvx_stats:
  var:
    stat: MEAN PROB
    statlc: mean prob
  metatask_ensgridvx_acc:
    var:
      ACCUM_HR: 03 06 24
      FCST_HR_LIST: '&3HRLY_FH; &6HRLY_FH; &24HRLY_FH;'
    task_run_ensgridvx_#statlc#_#ACCUM_HR#h:
      <<: *default_task
      command: '&LOAD_MODULES_RUN_TASK_FP; "run_vx" "&JOBSDIR;/JREGIONAL_RUN_VX_ENSGRID_#STAT#"'
      envars:
        <<: *default_vars
        ACCUM: '#ACCUM_HR#'
        FHR: '#FCST_HR_LIST#'
        OBS_DIR: '&CCPA_OBS_DIR;'
        VAR: APCP
      dependency:
        taskdep:
          attrs:
            task: run_ensgridvx_APCP
  task_run_enspointvx_#statlc#:
    <<: *default_task
    command: '&LOAD_MODULES_RUN_TASK_FP; "run_vx" "&JOBSDIR;/JREGIONAL_RUN_VX_ENSPOINT_#STAT#"'
    envars:
      <<: *default_vars
      OBS_DIR: '&NDAS_OBS_DIR;'
    dependency:
      taskdep:
        attrs:
          task: run_vx_enspoint

task_vx_enspoint:
  <<: *default_task
  command: '&LOAD_MODULES_RUN_TASK_FP; "run_vx" "&JOBSDIR;/JREGIONAL_RUN_VX_ENSPOINT"'
  envars:
    <<: *default_vars
    OBS_DIR: '&NDAS_OBS_DIR;'
  dependency:
    metataskdep:
      attrs:
        metatask: run_ensemble
